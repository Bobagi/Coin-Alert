<!DOCTYPE html>
<html>
  <head>
    <title>Coin-Alert Dashboard</title>
    <style>
      :root {
        --bg: #0b0c10;
        --panel: #11131a;
        --accent: #1f4b99;
        --accent-2: #e6b800;
        --text: #e8eaf0;
        --muted: #9ca3af;
        --success: #0bbf67;
        --error: #e74c3c;
        --card-radius: 12px;
        --shadow: 0 12px 35px rgba(0, 0, 0, 0.45);
      }

      * { box-sizing: border-box; }

      body {
        background: radial-gradient(circle at 20% 20%, rgba(31, 75, 153, 0.15), transparent 25%),
          radial-gradient(circle at 80% 0%, rgba(230, 184, 0, 0.08), transparent 30%),
          var(--bg);
        color: var(--text);
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 28px;
      }

      h1 {
        margin: 0 0 10px;
        letter-spacing: 0.5px;
      }

      h2 {
        margin: 0 0 12px;
        color: var(--accent-2);
        letter-spacing: 0.2px;
      }

      h3 {
        margin: 0 0 6px;
        color: var(--text);
      }

      p { margin: 0; }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 22px;
      }

      .subtitle {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .panel {
        background: linear-gradient(145deg, rgba(31, 75, 153, 0.08), rgba(17, 19, 26, 0.95));
        border: 1px solid rgba(230, 184, 0, 0.25);
        border-radius: var(--card-radius);
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .panel h3 { margin-bottom: 8px; }

      .stat-row {
        display: flex;
        justify-content: space-between;
        margin: 6px 0;
        font-size: 0.95rem;
      }

      .highlight {
        color: var(--accent-2);
        font-weight: 600;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        background: rgba(31, 75, 153, 0.25);
        color: var(--text);
      }

      .badge.success { background: rgba(11, 191, 103, 0.16); color: var(--success); }
      .badge.warn { background: rgba(230, 184, 0, 0.16); color: var(--accent-2); }

      .log-area {
        background: #0b0d13;
        border: 1px solid rgba(230, 184, 0, 0.2);
        border-radius: var(--card-radius);
        padding: 12px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        max-height: 260px;
        overflow-y: auto;
        box-shadow: var(--shadow);
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 28px 0 14px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }

      .form-card {
        background: rgba(17, 19, 26, 0.92);
        border: 1px solid rgba(31, 75, 153, 0.35);
        border-radius: var(--card-radius);
        padding: 14px;
        box-shadow: var(--shadow);
      }

      label {
        display: block;
        font-size: 0.9rem;
        color: var(--muted);
        margin-bottom: 4px;
      }

      input, select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(230, 184, 0, 0.25);
        background: rgba(11, 13, 19, 0.85);
        color: var(--text);
        font-size: 0.95rem;
      }

      .button {
        width: 100%;
        margin-top: 10px;
        padding: 11px 12px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(90deg, #1f4b99, #2f6cd6);
        color: #fff;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(31, 75, 153, 0.35);
        transition: transform 0.08s ease, box-shadow 0.12s ease;
      }

      .button:hover { transform: translateY(-1px); box-shadow: 0 14px 38px rgba(31, 75, 153, 0.45); }
      .button:active { transform: translateY(0); }

      .status {
        margin-top: 8px;
        font-size: 0.9rem;
      }

      .status.success { color: var(--success); }
      .status.error { color: var(--error); }

      .config-area {
        background: linear-gradient(180deg, rgba(31, 75, 153, 0.08), rgba(17, 19, 26, 0.96));
        border: 1px solid rgba(230, 184, 0, 0.2);
        border-radius: var(--card-radius);
        padding: 16px;
        box-shadow: var(--shadow);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 12px;
        background: rgba(230, 184, 0, 0.1);
        color: var(--accent-2);
        font-weight: 600;
      }

      .divider { height: 1px; background: rgba(255, 255, 255, 0.06); margin: 16px 0; }
    </style>
  </head>
  <body>
    <header class="page-header">
      <div>
        <h1>Coin-Alert Dashboard</h1>
        <p class="subtitle">Monitoramento em tempo real e ajustes rápidos de auto-buy, auto-sell e compras diárias.</p>
      </div>
      <div class="pill" id="refresh-indicator">Atualizando a cada 5s</div>
    </header>

    <section class="cards-grid" id="summary-cards"></section>

    <div class="section-title">
      <h2>Configurações rápidas</h2>
      <span class="subtitle">Adicione ou ajuste limites sem sair do painel</span>
    </div>
    <div class="config-area">
      <div class="form-grid">
        <form class="form-card" id="auto-buy-form">
          <h3>Auto Buy</h3>
          <label for="auto-buy-email">Email</label>
          <input id="auto-buy-email" name="email" type="email" required />
          <label for="auto-buy-symbol">Símbolo</label>
          <input id="auto-buy-symbol" name="symbol" placeholder="BTCUSDT" list="symbol-options" required />
          <label for="auto-buy-limit">Limite (BRL)</label>
          <input id="auto-buy-limit" name="quotaLimitBrl" type="number" step="0.01" required />
          <button class="button" type="submit">Salvar Auto Buy</button>
          <div class="status" id="auto-buy-status"></div>
        </form>

        <form class="form-card" id="auto-sell-form">
          <h3>Auto Sell</h3>
          <label for="auto-sell-email">Email</label>
          <input id="auto-sell-email" name="email" type="email" required />
          <label for="auto-sell-symbol">Símbolo</label>
          <input id="auto-sell-symbol" name="symbol" placeholder="BTCUSDT" list="symbol-options" required />
          <label for="auto-sell-limit">Limite (BRL)</label>
          <input id="auto-sell-limit" name="sellLimitBrl" type="number" step="0.01" required />
          <button class="button" type="submit">Salvar Auto Sell</button>
          <div class="status" id="auto-sell-status"></div>
        </form>

        <form class="form-card" id="daily-buy-form">
          <h3>Daily Buy</h3>
          <label for="daily-buy-email">Email</label>
          <input id="daily-buy-email" name="email" type="email" required />
          <label for="daily-buy-symbol">Símbolo</label>
          <input id="daily-buy-symbol" name="symbol" placeholder="ETHUSDT" list="symbol-options" required />
          <label for="daily-buy-amount">Valor por compra (BRL)</label>
          <input id="daily-buy-amount" name="amountBrl" type="number" step="0.01" required />
          <button class="button" type="submit">Registrar Daily Buy</button>
          <div class="status" id="daily-buy-status"></div>
        </form>
      </div>
      <datalist id="symbol-options"></datalist>
    </div>

    <div class="section-title">
      <h2>Métricas em tempo real</h2>
      <span class="subtitle">Visão consolidada de limites, posições e thresholds</span>
    </div>
    <section class="cards-grid">
      <div class="panel">
        <h3>Crypto Thresholds</h3>
        <div id="threshold-list"></div>
      </div>
      <div class="panel">
        <h3>Daily Buy</h3>
        <p id="daily-summary" class="subtitle"></p>
        <div class="divider"></div>
        <div id="daily-config-list"></div>
      </div>
      <div class="panel">
        <h3>Auto Buy</h3>
        <div id="auto-buy-quotas"></div>
      </div>
      <div class="panel">
        <h3>Auto Sell</h3>
        <div id="auto-sell-quotas"></div>
      </div>
    </section>

    <div class="section-title">
      <h2>Logs</h2>
      <span class="subtitle">Últimos eventos e execuções</span>
    </div>
    <section class="cards-grid">
      <div class="panel">
        <h3>Daily Buy Logs</h3>
        <div class="log-area" id="daily-logs"></div>
      </div>
      <div class="panel">
        <h3>Auto Buy Logs</h3>
        <div class="log-area" id="auto-buy-logs"></div>
      </div>
      <div class="panel">
        <h3>Auto Sell Logs</h3>
        <div class="log-area" id="auto-sell-logs"></div>
      </div>
      <div class="panel">
        <h3>Email Logs</h3>
        <div class="log-area" id="email-logs"></div>
      </div>
    </section>

    <script>
      const dashboardState = {
        refreshIntervalMs: 5000,
        apiPrefix: "{{ api_prefix }}",
        endpoints: {},
        elements: {
          summaryCards: document.getElementById('summary-cards'),
          thresholds: document.getElementById('threshold-list'),
          dailySummary: document.getElementById('daily-summary'),
          dailyConfigs: document.getElementById('daily-config-list'),
          dailyLogs: document.getElementById('daily-logs'),
          autoBuyQuotas: document.getElementById('auto-buy-quotas'),
          autoBuyLogs: document.getElementById('auto-buy-logs'),
          autoSellQuotas: document.getElementById('auto-sell-quotas'),
          autoSellLogs: document.getElementById('auto-sell-logs'),
          emailLogs: document.getElementById('email-logs'),
          refreshIndicator: document.getElementById('refresh-indicator'),
          autoBuyStatus: document.getElementById('auto-buy-status'),
          autoSellStatus: document.getElementById('auto-sell-status'),
          dailyBuyStatus: document.getElementById('daily-buy-status'),
          symbolDataList: document.getElementById('symbol-options'),
        },
        availableSymbols: new Set(),
      };

      const initialData = {{ dashboard_data | tojson }};
      const dashboardBasePath = "{{ url_for('dashboard.dashboard') }}";

      function stripDashboardBasePath(targetPath) {
        if (!dashboardBasePath) {
          return targetPath;
        }
        if (!targetPath.startsWith(dashboardBasePath)) {
          return targetPath;
        }
        const strippedPath = targetPath.slice(dashboardBasePath.length) || '/';
        return strippedPath.startsWith('/') ? strippedPath : `/${strippedPath}`;
      }

      function buildEndpoint(path) {
        const normalizedPath = path.startsWith('/') ? path : `/${path}`;
        const pathWithoutBase = stripDashboardBasePath(normalizedPath);
        const normalizedPrefix = dashboardState.apiPrefix || '';
        return `${normalizedPrefix}${pathWithoutBase}`;
      }

      dashboardState.endpoints = {
        data: buildEndpoint("{{ url_for('dashboard.dashboard_data') }}"),
        autoBuyConfig: buildEndpoint("{{ url_for('dashboard.create_or_update_auto_buy_quota') }}"),
        autoSellConfig: buildEndpoint("{{ url_for('dashboard.create_or_update_auto_sell_quota') }}"),
        dailyBuyConfig: buildEndpoint("{{ url_for('dashboard.create_daily_buy_config') }}"),
        symbols: buildEndpoint("{{ url_for('dashboard.crypto_symbols') }}"),
      };

      function formatCurrency(value) {
        return `R$${Number(value || 0).toFixed(2)}`;
      }

      function formatDate(value) {
        if (!value) {
          return '—';
        }
        const date = new Date(value);
        return date.toLocaleString();
      }

      function renderSummaryCards(data) {
        const cards = [
          {
            title: 'Auto Buy Quotas',
            value: data.autoBuy?.quotas?.length || 0,
            detail: 'Usuários com auto buy ativo',
          },
          {
            title: 'Auto Sell Quotas',
            value: data.autoSell?.quotas?.length || 0,
            detail: 'Limites de saída monitorados',
          },
          {
            title: 'Daily Buys',
            value: data.daily?.configs?.length || 0,
            detail: `Execução às ${data.daily?.dipHourUtc || '--'}:00 UTC`,
          },
          {
            title: 'Thresholds',
            value: data.thresholds?.length || 0,
            detail: 'Alertas de preço configurados',
          },
        ];

        const cardMarkup = cards.map((card) => `
          <div class="panel">
            <div class="badge">${card.title}</div>
            <div style="margin-top: 10px; font-size: 2rem; font-weight: 800; color: var(--accent-2);">${card.value}</div>
            <p class="subtitle" style="margin-top: 4px;">${card.detail}</p>
          </div>
        `);

        dashboardState.elements.summaryCards.innerHTML = cardMarkup.join('');
      }

      function renderThresholds(thresholds) {
        if (!thresholds.length) {
          dashboardState.elements.thresholds.innerHTML = '<p class="subtitle">Nenhum threshold registrado.</p>';
          return;
        }

        const listItems = thresholds.map((threshold) => {
          const direction = threshold.greaterThanCurrent ? '>' : '<';
          return `
            <div class="stat-row">
              <span>${threshold.email} — ${threshold.symbol}</span>
              <span class="highlight">${threshold.threshold} ${direction}</span>
            </div>
          `;
        });
        dashboardState.elements.thresholds.innerHTML = listItems.join('');
      }

      function renderDaily(daily) {
        const { dailySummary, dailyConfigs, dailyLogs } = dashboardState.elements;
        const minimumLabel = daily.minimumPerOrderBrl
          ? `piso por ordem ~${formatCurrency(daily.minimumPerOrderBrl)}`
          : 'piso por ordem indisponível';
        dailySummary.textContent = `Daily às ${daily.dipHourUtc}:00 UTC (${daily.dipHourBrl}:00 BRT) — ${minimumLabel}.`;

        const configItems = daily.configs.map((config) => {
          return `<div class="stat-row"><span>${config.email} — ${config.symbol}</span><span class="highlight">${formatCurrency(config.amountBrl)}</span></div>`;
        });
        dailyConfigs.innerHTML = configItems.join('') || '<p class="subtitle">Nenhuma compra diária configurada.</p>';
        dailyLogs.textContent = daily.logs || '';
      }

      function renderAutoBuy(autoBuy) {
        const { autoBuyQuotas, autoBuyLogs } = dashboardState.elements;
        autoBuyLogs.textContent = autoBuy.logs || '';
        if (!autoBuy.quotas.length) {
          autoBuyQuotas.innerHTML = '<p class="subtitle">Nenhum auto buy configurado.</p>';
          return;
        }

        const quotaCards = autoBuy.quotas.map((quota) => {
          const lastBuy = quota.lastBuy
            ? `${formatDate(quota.lastBuy.eventDate)} — ${quota.lastBuy.status} — ${formatCurrency(quota.lastBuy.quoteQty)}`
            : 'Nenhuma compra ainda';
          const lastSell = quota.lastSell
            ? `${formatDate(quota.lastSell.eventDate)} — ${quota.lastSell.status} — ${formatCurrency(quota.lastSell.quoteQty)}`
            : 'Nenhuma venda ainda';
          const releaseAt = quota.lastReleaseAt ? formatDate(quota.lastReleaseAt) : '—';

          return `
            <div class="form-card" style="margin-bottom: 10px;">
              <div class="stat-row"><strong>${quota.email}</strong><span class="badge">${quota.symbol}</span></div>
              <div class="stat-row"><span>Limite</span><span class="highlight">${formatCurrency(quota.quotaLimitBrl)}</span></div>
              <div class="stat-row"><span>Consumido</span><span>${formatCurrency(quota.quotaUsedBrl)}</span></div>
              <div class="stat-row"><span>Disponível</span><span>${formatCurrency(quota.quotaRemainingBrl)}</span></div>
              <div class="stat-row"><span>Bloqueado</span><span>${formatCurrency(quota.lockedExposure)}</span></div>
              <div class="stat-row"><span>Posições abertas</span><span>${quota.openPositions}</span></div>
              <div class="divider"></div>
              <p class="subtitle">Último buy: ${lastBuy}</p>
              <p class="subtitle">Último sell: ${lastSell}</p>
              <p class="subtitle">Última liberação: ${releaseAt}</p>
            </div>
          `;
        });
        autoBuyQuotas.innerHTML = quotaCards.join('');
      }

      function renderAutoSell(autoSell) {
        const { autoSellQuotas, autoSellLogs } = dashboardState.elements;
        autoSellLogs.textContent = autoSell.logs || '';
        if (!autoSell.quotas.length) {
          autoSellQuotas.innerHTML = '<p class="subtitle">Nenhum auto sell configurado.</p>';
          return;
        }

        const quotaCards = autoSell.quotas.map((quota) => {
          return `
            <div class="form-card" style="margin-bottom: 10px;">
              <div class="stat-row"><strong>${quota.email}</strong><span class="badge warn">${quota.symbol}</span></div>
              <div class="stat-row"><span>Limite</span><span class="highlight">${formatCurrency(quota.limit)}</span></div>
              <div class="stat-row"><span>Em uso</span><span>${formatCurrency(quota.used)}</span></div>
            </div>
          `;
        });
        autoSellQuotas.innerHTML = quotaCards.join('');
      }

      function renderLogs(logs) {
        dashboardState.elements.emailLogs.textContent = logs.emails || '';
        if (dashboardState.elements.dailyLogs.textContent !== undefined && logs.daily) {
          dashboardState.elements.dailyLogs.textContent = logs.daily;
        }
        if (dashboardState.elements.autoSellLogs.textContent !== undefined && logs.autoSell) {
          dashboardState.elements.autoSellLogs.textContent = logs.autoSell;
        }
        if (dashboardState.elements.autoBuyLogs.textContent !== undefined && logs.autoBuy) {
          dashboardState.elements.autoBuyLogs.textContent = logs.autoBuy;
        }
      }

      function applyDashboardData(data) {
        if (data.apiPrefix && data.apiPrefix !== dashboardState.apiPrefix) {
          dashboardState.apiPrefix = data.apiPrefix;
        }
        populateSymbolOptions(data.availableSymbols || []);
        renderSummaryCards(data);
        renderThresholds(data.thresholds || []);
        renderDaily({ ...data.daily, logs: data.logs?.daily });
        renderAutoBuy({ quotas: data.autoBuy?.quotas || [], logs: data.logs?.autoBuy });
        renderAutoSell({ quotas: data.autoSell?.quotas || [], logs: data.logs?.autoSell });
        renderLogs(data.logs || {});
      }

      async function fetchDashboardData() {
        try {
          dashboardState.elements.refreshIndicator.textContent = 'Atualizando...';
          const response = await fetch(dashboardState.endpoints.data);
          if (!response.ok) {
            throw new Error(`Falha ao carregar dados do dashboard (${response.status})`);
          }
          const payload = await response.json();
          if (payload.apiPrefix && payload.apiPrefix !== dashboardState.apiPrefix) {
            dashboardState.apiPrefix = payload.apiPrefix;
          }
          applyDashboardData(payload);
          dashboardState.elements.refreshIndicator.textContent = 'Atualizado a cada 5s';
        } catch (error) {
          dashboardState.elements.refreshIndicator.textContent = 'Erro ao atualizar';
          console.error('Dashboard refresh failed', error);
        }
      }

      function buildPayloadFromForm(formElement) {
        const formData = new FormData(formElement);
        return Object.fromEntries(formData.entries());
      }

      function populateSymbolOptions(symbols) {
        if (!symbols || !symbols.length) {
          return;
        }
        symbols.forEach((symbol) => dashboardState.availableSymbols.add(symbol));
        const sortedSymbols = Array.from(dashboardState.availableSymbols).sort();
        dashboardState.elements.symbolDataList.innerHTML = sortedSymbols
          .map((symbol) => `<option value="${symbol}"></option>`)
          .join('');
      }

      async function refreshSymbolOptionsFromServer() {
        try {
          const response = await fetch(dashboardState.endpoints.symbols);
          if (!response.ok) {
            return;
          }
          const payload = await response.json();
          populateSymbolOptions(payload.symbols || []);
        } catch (error) {
          console.warn('Não foi possível atualizar símbolos', error);
        }
      }

      async function submitConfiguration(formElement, endpoint, statusElement) {
        const payload = buildPayloadFromForm(formElement);
        statusElement.textContent = 'Enviando...';
        statusElement.className = 'status';
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const rawText = await response.text();
          let result;
          try {
            result = JSON.parse(rawText);
          } catch (parseError) {
            throw new Error('Resposta inválida do servidor. Verifique os dados e tente novamente.');
          }
          if (!response.ok || result.status === 'error') {
            const detailedMessage = result.message || rawText || 'Erro ao salvar configuração';
            throw new Error(`${detailedMessage} (HTTP ${response.status})`);
          }
          statusElement.textContent = result.message || 'Configuração salva';
          statusElement.className = 'status success';
          formElement.reset();
          fetchDashboardData();
        } catch (error) {
          statusElement.textContent = error.message;
          statusElement.className = 'status error';
        }
      }

      document.getElementById('auto-buy-form').addEventListener('submit', (event) => {
        event.preventDefault();
        submitConfiguration(event.target, dashboardState.endpoints.autoBuyConfig, dashboardState.elements.autoBuyStatus);
      });

      document.getElementById('auto-sell-form').addEventListener('submit', (event) => {
        event.preventDefault();
        submitConfiguration(event.target, dashboardState.endpoints.autoSellConfig, dashboardState.elements.autoSellStatus);
      });

      document.getElementById('daily-buy-form').addEventListener('submit', (event) => {
        event.preventDefault();
        submitConfiguration(event.target, dashboardState.endpoints.dailyBuyConfig, dashboardState.elements.dailyBuyStatus);
      });

      applyDashboardData(initialData);
      refreshSymbolOptionsFromServer();
      setInterval(fetchDashboardData, dashboardState.refreshIntervalMs);
    </script>
  </body>
</html>
